<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duck Rescue: Storm Surge</title>
    <style>
        :root {
            --pond-bg: #2980b9;      
            --water-bg: #3498db;     
            --accent: #f1c40f;       
            --danger: #e74c3c;       
            --nest-green: #2ecc71;   
            --text-white: #ffffff;
            --ui-dark: #1a2621;
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: #050d08;
            color: var(--text-white);
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; min-height: 100vh; overflow-y: auto; 
        }

        .main-wrapper { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; padding: 15px; gap: 20px; }
        .game-column { width: 100%; max-width: 450px; position: relative; }

        .game-container {
            background: var(--pond-bg); padding: 12px; border-radius: 15px; border: 3px solid white;
            text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); overflow: hidden; 
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 60; }
        .game-title { color: var(--accent); margin: 0; text-shadow: 2px 2px 0 #000; font-size: 1.5rem; }
        .icon-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; }

        .hud-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 5px; margin-bottom: 8px; }
        .hud-box { background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; }
        .target-box { border: 1px solid var(--accent); color: var(--accent); }
        .sub-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;}

        .boost-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
        #boostBar { width: 100%; height: 100%; background: linear-gradient(to right, var(--accent), #e67e22); transition: width 0.1s; }

        canvas { background: var(--water-bg); display: block; margin: auto; border-radius: 10px; width: 100%; aspect-ratio: 1 / 1; }

        /* --- D-PAD PLACEMENT LOGIC --- */
        .overlay-dpad {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 45; opacity: 0.4; pointer-events: auto; scale: 0.8;
        }

        .mobile-controls { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; display: flex; justify-content: center; }
        .d-pad-grid { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); gap: 8px; }
        .d-btn { background: #34495e; border: 2px solid #2c3e50; border-radius: 10px; color: white; display: flex; justify-content: center; align-items: center; }
        .center-boost { background: #c0392b; border-radius: 50%; font-size: 1.5rem; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 20, 0.98); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 12px; padding: 20px; }
        .btn { padding: 15px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; text-transform: uppercase; }
        .start-btn { background: var(--nest-green); box-shadow: 0 4px 0 #219150; }

        .settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .settings-content { background: #2c3e50; padding: 25px; border-radius: 20px; border: 2px solid var(--accent); width: 90%; max-width: 350px; text-align: center; }
        .setting-row { margin: 15px 0; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .toggle-group { display: flex; gap: 5px; background: #1a252f; padding: 5px; border-radius: 25px; }
        .toggle-btn { padding: 8px 12px; border: none; background: transparent; color: #7f8c8d; cursor: pointer; font-size: 0.8rem; font-weight: bold; border-radius: 20px; }
        .toggle-btn.active { background: var(--accent); color: black; }

        .info-panel { background: var(--ui-dark); padding: 20px; border-radius: 15px; border: 1px solid #444; width: 100%; max-width: 450px; display: block; }

        @media (min-width: 900px) {
            .main-wrapper { flex-direction: row; align-items: flex-start; }
            .info-panel { position: sticky; top: 20px; width: 300px; }
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="game-column">
            <div class="game-container" id="gamePort">
                <div class="top-bar">
                    <h1 class="game-title">DUCK RESCUE</h1>
                    <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
                </div>

                <div id="statusOverlay" class="overlay">
                    <h1 id="statusTitle">READY?</h1>
                    <p id="waveTitle" style="color: var(--accent); font-weight: bold;">Wave 1</p>
                    <p id="waveDesc" style="color:#bdc3c7; font-size: 0.9rem; margin-bottom:20px;"></p>
                    <button id="mainActionBtn" class="btn start-btn" onclick="prepareWave(1)">‚ñ∂ START WAVE</button>
                </div>

                <div class="hud-grid">
                    <div class="hud-box">W: <span id="levelDisplay">1</span></div>
                    <div class="hud-box target-box">T: <span id="savedDisplay">0</span>/<span id="targetDisplay">3</span></div>
                    <div class="hud-box">S: <span id="scoreDisplay">0</span></div>
                </div>

                <div class="sub-header">
                    <div id="livesDisplay">‚ù§‚ù§‚ù§‚ù§‚ù§</div>
                    <div>Casualties: <span id="deathDisplay">0</span> üíÄ</div>
                </div>

                <div class="boost-container"><div id="boostBar"></div></div>

                <div style="position: relative;">
                    <canvas id="gameCanvas"></canvas>
                    <div id="inlineDpad" class="d-pad-grid overlay-dpad" style="display: none;"></div>
                </div>

                <div class="ui-layer"><button class="btn" style="background:#95a5a6; width:100%;" onclick="togglePause()">PAUSE</button></div>
            </div>

            <div id="externalDpad" class="mobile-controls" style="display: none;"></div>
        </div>

        <div class="info-panel">
            <h3>MISSION BRIEFING</h3>
            <p id="pcGuide"><strong>PC Controls:</strong><br>‚Ä¢ Use <b>Arrow Keys</b> or <b>WASD</b> to swim.<br>‚Ä¢ Press <b>SPACE</b> for speed boost.</p>
            <hr style="border-color: #444;">
            <p>üêä <strong>Crocodile:</strong> Eats you and any ducklings he touches (even unrescued ones!).</p>
            <p>üêü <strong>Pike:</strong> Scares ducklings away. Harmless to Mama.</p>
            <a href="../index.html" style="color:var(--accent); text-decoration:none; font-weight:bold;">‚Üê Gaming Hub</a>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2 style="color: var(--accent);">SETTINGS</h2>
            <div class="setting-row">
                <label>Control Type:</label>
                <div class="toggle-group">
                    <button class="toggle-btn" id="setJoy" onclick="setControl('joystick')">Joystick</button>
                    <button class="toggle-btn" id="setDpad" onclick="setControl('dpad')">D-Pad</button>
                </div>
            </div>
            <div class="setting-row">
                <label>D-Pad Style:</label>
                <div class="toggle-group">
                    <button class="toggle-btn" id="setExt" onclick="setDpadPos('external')">External</button>
                    <button class="toggle-btn" id="setOvr" onclick="setDpadPos('overlay')">Overlay</button>
                </div>
            </div>
            <button class="btn" style="background:var(--accent); color:black; width:100%;" onclick="closeSettings()">SAVE</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 400; canvas.height = 400;

        const WAVE_TEXT = { 1: "Learn to rescue. Predators are hungry!", 2: "The Pike is here. He scares ducklings away.", 3: "High Stakes! Crocodile eats everything." };

        let settings = { 
            control: localStorage.getItem('dControl') || 'joystick', 
            dPos: localStorage.getItem('dPos') || 'external',
            sens: 30 
        };

        let gameState = { active: false, paused: true, level: 1, score: 0, lives: 5, casualties: 0, saved: 0, target: 3, boost: 100 };
        let mama = { x: 200, y: 200, speed: 3 };
        let ducklings = []; let history = []; let enemies = [];
        let lostDuckling = { x: 100, y: 100 }; let nest = { x: 340, y: 60, size: 40 };
        let keys = {}; let isBoosting = false;

        // DPAD TEMPLATE
        const dpadHTML = `
            <button class="d-btn" data-dir="UL">‚ó§</button><button class="d-btn" data-dir="U">‚ñ≤</button><button class="d-btn" data-dir="UR">‚ó•</button>
            <button class="d-btn" data-dir="L">‚óÄ</button><button class="d-btn center-boost" data-dir="B">üöÄ</button><button class="d-btn" data-dir="R">‚ñ∂</button>
            <button class="d-btn" data-dir="DL">‚ó£</button><button class="d-btn" data-dir="D">‚ñº</button><button class="d-btn" data-dir="DR">‚ó¢</button>
        `;

        function prepareWave(lvl) {
            if (lvl === 1) { gameState.score = 0; gameState.lives = 5; gameState.casualties = 0; }
            gameState.active = true; gameState.paused = false; gameState.level = lvl;
            gameState.saved = 0; gameState.target = 2 + lvl;
            mama.x = 200; mama.y = 200; enemies = []; history = []; ducklings = [];
            
            let speed = 1 + (lvl * 0.15);
            if (lvl >= 2) enemies.push({ type: 'pike', x: -50, y: 150, s: 2 * speed });
            if (lvl >= 3) enemies.push({ type: 'croc', x: 500, y: 300, s: -1.2 * speed });
            
            spawnBaby(); updateUI();
            document.getElementById("statusOverlay").style.display = "none";
            requestAnimationFrame(loop);
        }

        function spawnBaby() { lostDuckling.x = 50 + Math.random()*300; lostDuckling.y = 50 + Math.random()*300; }

        function update() {
            if (gameState.paused) return;
            let mx = 0, my = 0;
            if (keys.ArrowUp || keys.KeyW) my = -1; if (keys.ArrowDown || keys.KeyS) my = 1;
            if (keys.ArrowLeft || keys.KeyA) mx = -1; if (keys.ArrowRight || keys.KeyD) mx = 1;

            let s = isBoosting && gameState.boost > 0 ? 7 : 3;
            if (isBoosting) gameState.boost -= 1.5; else if (gameState.boost < 100) gameState.boost += 0.5;
            document.getElementById("boostBar").style.width = gameState.boost + "%";

            mama.x += mx * s; mama.y += my * s;
            mama.x = Math.max(20, Math.min(380, mama.x)); mama.y = Math.max(20, Math.min(380, mama.y));
            history.unshift({x: mama.x, y: mama.y}); if (history.length > 300) history.pop();

            enemies.forEach(e => {
                e.x += e.s;
                if (e.x > 450 || e.x < -100) e.x = e.s > 0 ? -50 : 500;
                
                // MAMA COLLISION
                if (Math.hypot(mama.x - e.x, mama.y - e.y) < 30 && e.type === 'croc') loseLife();

                // PRE-RESCUE BABY COLLISION (The New Logic)
                if (Math.hypot(lostDuckling.x - e.x, lostDuckling.y - e.y) < 25) {
                    gameState.casualties++; spawnBaby(); updateUI();
                }

                // LINE COLLISION
                ducklings.forEach((d, i) => {
                    let idx = (i+1)*15;
                    if (history[idx] && Math.hypot(history[idx].x - e.x, history[idx].y - e.y) < 25) {
                        if (e.type === 'croc') gameState.casualties += (ducklings.length - i);
                        ducklings.splice(i); updateUI();
                    }
                });
            });

            if (Math.hypot(mama.x - lostDuckling.x, mama.y - lostDuckling.y) < 30) { ducklings.push({}); spawnBaby(); }
            if (Math.hypot(mama.x - nest.x, mama.y - nest.y) < 35 && ducklings.length > 0) {
                gameState.score += ducklings.length; gameState.saved += ducklings.length;
                ducklings = []; updateUI();
                if (gameState.saved >= gameState.target) nextWave();
            }
        }

        function loop() { if (!gameState.active || gameState.paused) return; update(); draw(); requestAnimationFrame(loop); }

        function draw() {
            ctx.clearRect(0,0,400,400);
            ctx.font = "40px serif"; ctx.fillText("ü™∫", nest.x-20, nest.y+15);
            ctx.fillText("üê£", lostDuckling.x-15, lostDuckling.y+10);
            enemies.forEach(e => ctx.fillText(e.type === 'croc' ? "üêä" : "üêü", e.x-15, e.y+10));
            ctx.fillText("ü¶¢", mama.x-20, mama.y+15);
            ducklings.forEach((d,i) => {
                let p = history[(i+1)*15];
                if(p) ctx.fillText("üê•", p.x-10, p.y+10);
            });
        }

        function updateUI() {
            document.getElementById("scoreDisplay").innerText = gameState.score;
            document.getElementById("deathDisplay").innerText = gameState.casualties;
            document.getElementById("savedDisplay").innerText = gameState.saved;
            document.getElementById("targetDisplay").innerText = gameState.target;
            document.getElementById("livesDisplay").innerText = "‚ù§".repeat(gameState.lives);
        }

        function loseLife() {
            gameState.lives--; updateUI();
            if (gameState.lives <= 0) gameOver(); else { mama.x=200; mama.y=200; history=[]; }
        }

        function nextWave() {
            gameState.active = false;
            let next = gameState.level + 1;
            document.getElementById("statusOverlay").style.display = "flex";
            document.getElementById("statusTitle").innerText = "WAVE COMPLETE";
            document.getElementById("waveTitle").innerText = "Wave " + next;
            document.getElementById("waveDesc").innerText = WAVE_TEXT[next] || "The storm intensifies!";
            document.getElementById("mainActionBtn").onclick = () => prepareWave(next);
        }

        function gameOver() {
            gameState.active = false;
            document.getElementById("statusOverlay").style.display = "flex";
            document.getElementById("statusTitle").innerText = "GAME OVER";
            document.getElementById("waveDesc").innerText = "Final Score: " + gameState.score;
            document.getElementById("mainActionBtn").onclick = () => prepareWave(1);
        }

        function togglePause() { gameState.paused = !gameState.paused; if(!gameState.paused) loop(); }

        // SETTINGS LOGIC
        function openSettings() { document.getElementById("settingsModal").style.display="flex"; }
        function closeSettings() { document.getElementById("settingsModal").style.display="none"; applyUI(); }
        function setControl(c) { settings.control = c; localStorage.setItem('dControl', c); applyUI(); }
        function setDpadPos(p) { settings.dPos = p; localStorage.setItem('dPos', p); applyUI(); }

        function applyUI() {
            const ext = document.getElementById("externalDpad");
            const inl = document.getElementById("inlineDpad");
            ext.style.display = "none"; inl.style.display = "none";
            
            if (settings.control === 'dpad') {
                if (settings.dPos === 'external') { ext.style.display = "flex"; ext.innerHTML = dpadHTML; }
                else { inl.style.display = "grid"; inl.innerHTML = dpadHTML; }
                attachDpadEvents();
            }
            document.getElementById("setJoy").className = settings.control === 'joystick' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setDpad").className = settings.control === 'dpad' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setExt").className = settings.dPos === 'external' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setOvr").className = settings.dPos === 'overlay' ? 'toggle-btn active' : 'toggle-btn';
        }

        function attachDpadEvents() {
            document.querySelectorAll('.d-btn').forEach(b => {
                b.onpointerdown = (e) => {
                    const d = b.dataset.dir;
                    if(d === 'B') isBoosting = true;
                    else { if(d.includes('U')) keys.ArrowUp=true; if(d.includes('D')) keys.ArrowDown=true; if(d.includes('L')) keys.ArrowLeft=true; if(d.includes('R')) keys.ArrowRight=true; }
                };
                b.onpointerup = b.onpointerleave = () => { isBoosting=false; keys={}; };
            });
        }

        window.onkeydown = (e) => { keys[e.code]=true; if(e.code==='Space') isBoosting=true; };
        window.onkeyup = (e) => { keys[e.code]=false; if(e.code==='Space') isBoosting=false; };

        applyUI();
    </script>
</body>
</html>
