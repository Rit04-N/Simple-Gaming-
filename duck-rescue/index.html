<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duck Rescue: Storm Surge</title>
    <style>
        :root {
            --pond-bg: #2980b9;      
            --water-bg: #3498db;     
            --accent: #f1c40f;       
            --danger: #e74c3c;       
            --nest-green: #2ecc71;   
            --text-white: #ffffff;
            --ui-dark: #1a2621;
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: #050d08;
            color: var(--text-white);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; min-height: 100vh; overflow-y: auto; 
        }

        .main-wrapper { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; padding: 15px; gap: 20px; }
        .game-column { width: 100%; max-width: 450px; position: relative; }

        .game-container {
            background: var(--pond-bg); padding: 12px; border-radius: 15px; border: 3px solid white;
            text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); overflow: hidden; 
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 60; }
        .game-title { color: var(--accent); margin: 0; text-shadow: 2px 2px 0 #000; font-size: 1.5rem; }
        .icon-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; }

        /* --- UPDATED HUD --- */
        .hud-grid { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 8px; }
        .hud-box { 
            background: rgba(0,0,0,0.3); padding: 8px 12px; 
            border-radius: 8px; font-weight: bold; font-size: 0.9rem;
            flex: 1; display: flex; justify-content: center; align-items: center; white-space: nowrap;
        }
        .target-box { border: 1px solid var(--accent); color: var(--accent); flex: 1.2; }
        
        .sub-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;}

        .boost-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
        #boostBar { width: 100%; height: 100%; background: linear-gradient(to right, var(--accent), #e67e22); transition: width 0.1s; }

        canvas { background: var(--water-bg); display: block; margin: auto; border-radius: 10px; width: 100%; aspect-ratio: 1 / 1; }

        /* --- OVERLAY D-PAD STYLES --- */
        .overlay-dpad {
            position: absolute; 
            bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 45; opacity: 0.6; pointer-events: none; 
            transition: opacity 0.2s;
        }
        .overlay-dpad:hover { opacity: 0.9; }

        /* DRAG HANDLE */
        .dpad-handle {
            position: absolute; top: -25px; right: -25px;
            width: 35px; height: 35px;
            background: rgba(241, 196, 15, 0.8); color: black;
            border-radius: 50%; border: 2px solid white;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: move; pointer-events: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .mobile-controls { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; display: flex; justify-content: center; }
        .d-pad-grid { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); gap: 8px; pointer-events: auto; }
        .d-btn { background: #34495e; border: 2px solid #2c3e50; border-radius: 10px; color: white; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; pointer-events: auto;}
        .center-boost { background: #c0392b; border-radius: 50%; font-size: 1.5rem; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 20, 0.98); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 12px; padding: 20px; }
        .btn { padding: 15px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; text-transform: uppercase; font-size: 1rem;}
        .start-btn { background: var(--nest-green); box-shadow: 0 4px 0 #219150; }

        /* --- SETTINGS MODAL --- */
        .settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .settings-content { background: #2c3e50; padding: 20px; border-radius: 20px; border: 2px solid var(--accent); width: 90%; max-width: 350px; text-align: center; }
        .setting-row { margin: 15px 0; display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .toggle-group { display: flex; gap: 5px; background: #1a252f; padding: 5px; border-radius: 25px; }
        .toggle-btn { padding: 8px 15px; border: none; background: transparent; color: #7f8c8d; cursor: pointer; font-size: 0.9rem; font-weight: bold; border-radius: 20px; transition: 0.2s;}
        .toggle-btn.active { background: var(--accent); color: black; }
        input[type=range] { width: 80%; }

        .info-panel { background: var(--ui-dark); padding: 20px; border-radius: 15px; border: 1px solid #444; width: 100%; max-width: 450px; display: block; }
        .key-badge { display: inline-block; padding: 2px 8px; background: #34495e; border: 1px solid #7f8c8d; border-radius: 4px; font-family: monospace; color: #ecf0f1; font-size: 0.8rem; margin: 0 2px; }

        /* JOYSTICK BOOST BTN */
        .joystick-boost-btn {
            position: absolute; bottom: 30px; right: 20px;
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(231, 76, 60, 0.8); border: 3px solid rgba(255,255,255,0.5);
            color: white; font-weight: bold; font-size: 0.9rem;
            display: none; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            z-index: 40; cursor: pointer;
        }

        @media (min-width: 900px) {
            .main-wrapper { flex-direction: row; align-items: flex-start; }
            .info-panel { position: sticky; top: 20px; width: 300px; }
            .mobile-controls { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="game-column">
            <div class="game-container" id="gamePort">
                <div class="top-bar">
                    <h1 class="game-title">DUCK RESCUE</h1>
                    <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
                </div>

                <div id="statusOverlay" class="overlay">
                    <h1 id="statusTitle">READY?</h1>
                    <p id="waveTitle" style="color: var(--accent); font-weight: bold; font-size: 1.2rem;">Wave 1</p>
                    <p id="waveDesc" style="color:#bdc3c7; font-size: 0.9rem; margin-bottom:20px;"></p>
                    <button id="mainActionBtn" class="btn start-btn" onclick="prepareWave(1)">‚ñ∂ START WAVE</button>
                </div>

                <div class="hud-grid">
                    <div class="hud-box">Wave: <span id="levelDisplay">1</span></div>
                    <div class="hud-box target-box">Target: <span id="savedDisplay">0</span>/<span id="targetDisplay">3</span></div>
                    <div class="hud-box">Score: <span id="scoreDisplay">0</span></div>
                </div>

                <div class="sub-header">
                    <div id="livesDisplay">‚ù§‚ù§‚ù§‚ù§‚ù§</div>
                    <div>Casualties: <span id="deathDisplay">0</span> üíÄ</div>
                </div>

                <div class="boost-container"><div id="boostBar"></div></div>

                <div style="position: relative;">
                    <canvas id="gameCanvas"></canvas>
                    
                    <div id="overlayDpad" class="d-pad-grid overlay-dpad" style="display: none;">
                        <div id="dpadHandle" class="dpad-handle">‚ú•</div>
                        <button class="d-btn" data-key="UL">‚ó§</button><button class="d-btn" data-key="UP">‚ñ≤</button><button class="d-btn" data-key="UR">‚ó•</button>
                        <button class="d-btn" data-key="LEFT">‚óÄ</button><button class="d-btn center-boost" data-key="BOOST">üöÄ</button><button class="d-btn" data-key="RIGHT">‚ñ∂</button>
                        <button class="d-btn" data-key="DL">‚ó£</button><button class="d-btn" data-key="DOWN">‚ñº</button><button class="d-btn" data-key="DR">‚ó¢</button>
                    </div>

                    <button id="joyBoostBtn" class="joystick-boost-btn">üöÄ<br>BOOST</button>
                </div>

                <div class="ui-layer"><button class="btn" style="background:#95a5a6; width:100%;" onclick="togglePause()">PAUSE</button></div>
            </div>

            <div id="externalDpad" class="mobile-controls" style="display: none;">
                <div class="d-pad-grid">
                    <button class="d-btn" data-key="UL">‚ó§</button><button class="d-btn" data-key="UP">‚ñ≤</button><button class="d-btn" data-key="UR">‚ó•</button>
                    <button class="d-btn" data-key="LEFT">‚óÄ</button><button class="d-btn center-boost" data-key="BOOST">üöÄ</button><button class="d-btn" data-key="RIGHT">‚ñ∂</button>
                    <button class="d-btn" data-key="DL">‚ó£</button><button class="d-btn" data-key="DOWN">‚ñº</button><button class="d-btn" data-key="DR">‚ó¢</button>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h3>MISSION BRIEFING</h3>
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <strong style="color:#3498db">üñ•Ô∏è PC CONTROLS</strong><br>
                <div style="margin-top:5px; font-size: 0.9rem;">
                    Move: <span class="key-badge">WASD</span> or <span class="key-badge">ARROWS</span><br>
                    Boost: <span class="key-badge">SPACE</span>
                </div>
            </div>
            <hr style="border-color: #444;">
            <p>üêä <strong>Crocodile:</strong> Eats YOU and any ducklings he touches!</p>
            <p>üêü <strong>Pike:</strong> Harmless to Mama, but <span style="color:#e74c3c">DEADLY</span> to ducklings if they aren't rescued yet!</p>
            <a href="../index.html" style="color:var(--accent); text-decoration:none; font-weight:bold;">‚Üê Gaming Hub</a>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2 style="color: var(--accent); margin-top:0;">‚öôÔ∏è SETTINGS</h2>
            <div class="setting-row">
                <label>Control Type:</label>
                <div class="toggle-group">
                    <button class="toggle-btn" id="setJoy" onclick="setControl('joystick')">Joystick</button>
                    <button class="toggle-btn" id="setDpad" onclick="setControl('dpad')">D-Pad</button>
                </div>
            </div>
            <div class="setting-row" id="dpadPosRow">
                <label>D-Pad Position:</label>
                <div class="toggle-group">
                    <button class="toggle-btn" id="setExt" onclick="setDpadPos('external')">Bottom</button>
                    <button class="toggle-btn" id="setOvr" onclick="setDpadPos('overlay')">Overlay</button>
                </div>
                <p style="font-size: 0.75rem; margin-top:5px; color:#bdc3c7;">(Tip: In Overlay mode, drag the ‚ú• icon to move D-pad!)</p>
            </div>
            <div class="setting-row" id="sensRow">
                <label>Joystick Speed:</label>
                <input type="range" id="sensSlider" min="10" max="60" value="30" oninput="updateSens(this.value)">
                <span id="sensValue" style="color: var(--accent);">30</span>
            </div>
            <div class="setting-row">
                <label>Sound Effects:</label>
                <button class="toggle-btn active" id="btnSound" onclick="toggleSound()">ON</button>
            </div>
            <button class="btn" style="background:var(--accent); color:black; width:100%; margin-top:15px;" onclick="closeSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <script>
        // --- GAME CONFIG ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 400; canvas.height = 400;

        const WAVE_TEXT = { 1: "Learn to rescue. Predators are hungry!", 2: "The Pike is here. He scares ducklings away.", 3: "High Stakes! Crocodile eats everything." };
        const getStore = (k,d) => localStorage.getItem(k) || d;

        let settings = { 
            control: getStore('dControl','joystick'), 
            dPos: getStore('dPos','external'), 
            sens: parseInt(getStore('dSens','30')),
            sound: true
        };

        let gameState = { active: false, paused: true, level: 1, score: 0, lives: 5, casualties: 0, saved: 0, target: 3, boost: 100 };
        let mama = { x: 200, y: 200, speed: 3 };
        let ducklings = []; let history = []; let enemies = [];
        let lostDuckling = { x: 100, y: 100 }; let nest = { x: 340, y: 60, size: 40 };
        let keys = {}; let isBoosting = false;
        let joystick = { active: false, baseX:0, baseY:0, stickX:0, stickY:0, dx:0, dy:0 };

        let audioCtx;
        const Sfx = {
            play: (t) => {
                if(!settings.sound || !audioCtx) return;
                if(audioCtx.state==='suspended') audioCtx.resume();
                try {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    const now = audioCtx.currentTime;
                    if(t==='coin'){ o.freq=600; o.frequency.exponentialRampToValueAtTime(900,now+0.1); g.gain.value=0.1; o.start(now); o.stop(now+0.1); }
                    if(t==='hit'){ o.type='sawtooth'; o.freq=150; g.gain.value=0.2; o.start(now); o.stop(now+0.2); }
                    if(t==='win'){ o.type='square'; o.freq=400; o.frequency.linearRampToValueAtTime(800,now+0.3); g.gain.value=0.1; o.start(now); o.stop(now+0.4); }
                } catch(e){}
            }
        };

        function prepareWave(lvl) {
            if(!audioCtx) { audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
            if (lvl === 1) { gameState.score = 0; gameState.lives = 5; gameState.casualties = 0; }
            gameState.active = true; gameState.paused = false; gameState.level = lvl;
            gameState.saved = 0; gameState.target = 2 + lvl;
            mama.x = 200; mama.y = 200; enemies = []; history = []; ducklings = [];
            
            let speed = 1 + (lvl * 0.15);
            // RANDOMIZED START & STAGGERED APPEARANCE
            // X is randomized negatively so they don't all appear at same exact second
            // Y is randomized so they don't always use the same lane
            if (lvl >= 2) enemies.push({ type: 'pike', x: -50 - Math.random()*200, y: 50+Math.random()*300, s: 2 * speed });
            if (lvl >= 3) enemies.push({ type: 'croc', x: 500 + Math.random()*200, y: 50+Math.random()*300, s: -1.2 * speed });
            if (lvl >= 5) enemies.push({ type: 'croc', x: 500 + Math.random()*250, y: 50+Math.random()*300, s: -1.5 * speed });
            if (lvl >= 7) enemies.push({ type: 'pike', x: -50 - Math.random()*300, y: 50+Math.random()*300, s: 2.5 * speed });
            
            spawnBaby(); updateUI(); applyUI();
            document.getElementById("statusOverlay").style.display = "none";
            requestAnimationFrame(loop);
        }

        function spawnBaby() { lostDuckling.x = 50 + Math.random()*300; lostDuckling.y = 50 + Math.random()*300; }

        function update() {
            if (gameState.paused) return;
            let mx = 0, my = 0;
            if (keys.ArrowUp || keys.KeyW) my = -1; if (keys.ArrowDown || keys.KeyS) my = 1;
            if (keys.ArrowLeft || keys.KeyA) mx = -1; if (keys.ArrowRight || keys.KeyD) mx = 1;
            if (settings.control === 'joystick' && joystick.active) { mx = joystick.dx; my = joystick.dy; }

            let s = isBoosting && gameState.boost > 0 ? 7 : 3;
            if (isBoosting) gameState.boost -= 1.5; else if (gameState.boost < 100) gameState.boost += 0.5;
            document.getElementById("boostBar").style.width = gameState.boost + "%";

            if(mx!==0 || my!==0) {
                 if(!joystick.active) { let l = Math.sqrt(mx*mx+my*my); if(l>0){mx/=l; my/=l;} }
                 mama.x += mx * s; mama.y += my * s;
            }
            mama.x = Math.max(20, Math.min(380, mama.x)); mama.y = Math.max(20, Math.min(380, mama.y));
            history.unshift({x: mama.x, y: mama.y}); if (history.length > 300) history.pop();

            enemies.forEach(e => {
                e.x += e.s;
                if (e.x > 450 || e.x < -100) { 
                    e.x = e.s > 0 ? -50 : 500; 
                    e.y = 50 + Math.random()*300; // Randomize Y on respawn
                }
                
                if (Math.hypot(mama.x - e.x, mama.y - e.y) < 30 && e.type === 'croc') { Sfx.play('hit'); loseLife(); }

                // Pre-Rescue Death
                if (Math.hypot(lostDuckling.x - e.x, lostDuckling.y - e.y) < 25) {
                    Sfx.play('hit'); gameState.casualties++; spawnBaby(); updateUI();
                }

                // Line Death
                ducklings.forEach((d, i) => {
                    let idx = (i+1)*15;
                    if (history[idx] && Math.hypot(history[idx].x - e.x, history[idx].y - e.y) < 25) {
                        if (e.type === 'croc') { Sfx.play('hit'); gameState.casualties += (ducklings.length - i); }
                        ducklings.splice(i); updateUI();
                    }
                });
            });

            if (Math.hypot(mama.x - lostDuckling.x, mama.y - lostDuckling.y) < 30) { Sfx.play('coin'); ducklings.push({}); spawnBaby(); }
            if (Math.hypot(mama.x - nest.x, mama.y - nest.y) < 35 && ducklings.length > 0) {
                Sfx.play('win'); gameState.score += ducklings.length; gameState.saved += ducklings.length;
                ducklings = []; updateUI();
                if (gameState.saved >= gameState.target) nextWave();
            }
        }

        function loop() { if (!gameState.active || gameState.paused) return; update(); draw(); requestAnimationFrame(loop); }

        function draw() {
            ctx.clearRect(0,0,400,400);
            ctx.textAlign = "center"; ctx.textBaseline="middle";
            ctx.font = "40px serif"; ctx.fillText("ü™∫", nest.x, nest.y);
            ctx.fillText("üê£", lostDuckling.x, lostDuckling.y);
            enemies.forEach(e => ctx.fillText(e.type === 'croc' ? "üêä" : "üêü", e.x, e.y));
            
            ctx.save(); ctx.translate(mama.x, mama.y);
            if(keys.ArrowLeft || keys.KeyA || (joystick.active && joystick.dx<0)) ctx.scale(-1,1);
            ctx.fillText("ü¶¢", 0, 0); ctx.restore();

            ducklings.forEach((d,i) => { let p = history[(i+1)*15]; if(p) { ctx.font="20px serif"; ctx.fillText("üê•", p.x, p.y); } });

            if(settings.control==='joystick' && joystick.active){
                ctx.beginPath(); ctx.arc(joystick.baseX, joystick.baseY, 40, 0, 7);
                ctx.fillStyle="rgba(255,255,255,0.2)"; ctx.fill();
                ctx.beginPath(); ctx.arc(joystick.stickX, joystick.stickY, 15, 0, 7);
                ctx.fillStyle="orange"; ctx.fill();
            }
        }

        function updateUI() {
            document.getElementById("scoreDisplay").innerText = gameState.score;
            document.getElementById("deathDisplay").innerText = gameState.casualties;
            document.getElementById("savedDisplay").innerText = gameState.saved;
            document.getElementById("targetDisplay").innerText = gameState.target;
            document.getElementById("livesDisplay").innerText = "‚ù§".repeat(gameState.lives);
        }

        function loseLife() {
            gameState.lives--; updateUI();
            if (gameState.lives <= 0) gameOver(); else { mama.x=200; mama.y=200; history=[]; }
        }

        function nextWave() {
            gameState.active = false;
            let next = gameState.level + 1;
            document.getElementById("statusOverlay").style.display = "flex";
            document.getElementById("statusTitle").innerText = "WAVE COMPLETE";
            document.getElementById("waveTitle").innerText = "Wave " + next;
            document.getElementById("waveDesc").innerText = WAVE_TEXT[next] || "The storm intensifies!";
            document.getElementById("mainActionBtn").onclick = () => prepareWave(next);
        }

        function gameOver() {
            gameState.active = false;
            document.getElementById("statusOverlay").style.display = "flex";
            document.getElementById("statusTitle").innerText = "GAME OVER";
            document.getElementById("waveDesc").innerText = "Final Score: " + gameState.score;
            document.getElementById("mainActionBtn").onclick = () => prepareWave(1);
        }

        function togglePause() { 
            if(!gameState.active) return;
            gameState.paused = !gameState.paused; 
            document.getElementById("statusOverlay").style.display = gameState.paused ? "flex" : "none";
            if(gameState.paused) {
                 document.getElementById("statusTitle").innerText = "PAUSED";
                 document.getElementById("waveTitle").innerText=""; document.getElementById("waveDesc").innerText="";
                 document.getElementById("mainActionBtn").innerText="RESUME"; document.getElementById("mainActionBtn").onclick = togglePause;
            } else loop();
        }

        // --- SETTINGS & DRAG LOGIC ---
        function openSettings() { if(gameState.active && !gameState.paused) togglePause(); document.getElementById("settingsModal").style.display="flex"; applyUI(); }
        function closeSettings() { document.getElementById("settingsModal").style.display="none"; applyUI(); }
        function setControl(c) { settings.control = c; localStorage.setItem('dControl', c); applyUI(); }
        function setDpadPos(p) { settings.dPos = p; localStorage.setItem('dPos', p); applyUI(); }
        function updateSens(v) { settings.sens = parseInt(v); document.getElementById("sensValue").innerText=v; localStorage.setItem('dSens', v); }
        function toggleSound() { settings.sound = !settings.sound; applyUI(); }

        function applyUI() {
            const ext = document.getElementById("externalDpad");
            const inl = document.getElementById("overlayDpad");
            const joyBtn = document.getElementById("joyBoostBtn");
            const sensRow = document.getElementById("sensRow");
            const dpadPosRow = document.getElementById("dpadPosRow");

            ext.style.display = "none"; inl.style.display = "none"; joyBtn.style.display="none";

            document.getElementById("setJoy").className = settings.control === 'joystick' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setDpad").className = settings.control === 'dpad' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setExt").className = settings.dPos === 'external' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("setOvr").className = settings.dPos === 'overlay' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("btnSound").className = settings.sound ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById("btnSound").innerText = settings.sound ? "ON" : "OFF";
            document.getElementById("sensSlider").value = settings.sens;

            if (settings.control === 'dpad') {
                sensRow.style.display = 'none'; dpadPosRow.style.display = 'flex';
                if (settings.dPos === 'external') { 
                    ext.style.display = "flex"; 
                } else { 
                    inl.style.display = "grid"; 
                    // Load Saved Position
                    const savedLeft = localStorage.getItem('dpadX');
                    const savedTop = localStorage.getItem('dpadY');
                    if(savedLeft && savedTop) {
                        inl.style.bottom = 'auto'; inl.style.left = savedLeft + 'px'; inl.style.top = savedTop + 'px'; inl.style.transform = 'none';
                    }
                }
            } else {
                sensRow.style.display = 'flex'; dpadPosRow.style.display = 'none';
                if(gameState.active && !gameState.paused) joyBtn.style.display="flex";
            }
        }

        // --- DRAG LOGIC FOR OVERLAY DPAD ---
        const dpadHandle = document.getElementById("dpadHandle");
        const overlayDpad = document.getElementById("overlayDpad");
        let isDragging = false;
        let dragOffsetX = 0; let dragOffsetY = 0;

        dpadHandle.addEventListener('touchstart', (e) => {
            e.preventDefault(); e.stopPropagation();
            isDragging = true;
            const touch = e.touches[0];
            const rect = overlayDpad.getBoundingClientRect();
            // Calculate offset so we drag from where we touched, not snapping to top-left
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            
            // Switch from CSS positioning to absolute pixel positioning
            overlayDpad.style.bottom = 'auto';
            overlayDpad.style.transform = 'none';
        }, {passive: false});

        document.addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            const newX = touch.clientX - dragOffsetX;
            const newY = touch.clientY - dragOffsetY;
            overlayDpad.style.left = newX + 'px';
            overlayDpad.style.top = newY + 'px';
        }, {passive: false});

        document.addEventListener('touchend', () => {
            if(isDragging) {
                isDragging = false;
                // Save position
                localStorage.setItem('dpadX', overlayDpad.style.left.replace('px',''));
                localStorage.setItem('dpadY', overlayDpad.style.top.replace('px',''));
            }
        });

        // INPUT HANDLERS
        document.querySelectorAll('.d-btn').forEach(b => {
            b.onpointerdown = (e) => {
                if(e.target.id === 'dpadHandle') return;
                const d = b.dataset.key;
                if(d === 'BOOST') isBoosting = true;
                else { if(d.includes('U')) keys.ArrowUp=true; if(d.includes('D')) keys.ArrowDown=true; if(d.includes('L')) keys.ArrowLeft=true; if(d.includes('R')) keys.ArrowRight=true; }
            };
            b.onpointerup = b.onpointerleave = () => { isBoosting=false; keys={}; };
        });

        window.onkeydown = (e) => { keys[e.code]=true; if(e.code==='Space') isBoosting=true; };
        window.onkeyup = (e) => { keys[e.code]=false; if(e.code==='Space') isBoosting=false; };

        canvas.addEventListener("touchstart", (e) => {
            if (settings.control !== 'joystick' || !gameState.active || gameState.paused) return;
            e.preventDefault();
            const r = canvas.getBoundingClientRect();
            joystick.active = true;
            joystick.baseX = (e.touches[0].clientX - r.left) * (canvas.width/r.width);
            joystick.baseY = (e.touches[0].clientY - r.top) * (canvas.height/r.height);
            joystick.stickX = joystick.baseX; joystick.stickY = joystick.baseY;
            document.getElementById("joyBoostBtn").style.display="flex";
        }, {passive:false});

        canvas.addEventListener("touchmove", (e) => {
            if (!joystick.active) return;
            e.preventDefault();
            const r = canvas.getBoundingClientRect();
            const tx = (e.touches[0].clientX - r.left) * (canvas.width/r.width);
            const ty = (e.touches[0].clientY - r.top) * (canvas.height/r.height);
            const d = Math.hypot(tx-joystick.baseX, ty-joystick.baseY);
            const ang = Math.atan2(ty-joystick.baseY, tx-joystick.baseX);
            const lim = Math.min(d, 40);
            joystick.stickX = joystick.baseX + Math.cos(ang)*lim;
            joystick.stickY = joystick.baseY + Math.sin(ang)*lim;
            const f = Math.min(d / (70 - settings.sens), 1);
            joystick.dx = Math.cos(ang)*f; joystick.dy = Math.sin(ang)*f;
        }, {passive:false});

        canvas.addEventListener("touchend", () => { joystick.active=false; joystick.dx=0; joystick.dy=0; });
        const jBtn = document.getElementById("joyBoostBtn");
        jBtn.addEventListener("touchstart", (e)=>{e.preventDefault(); isBoosting=true;});
        jBtn.addEventListener("touchend", (e)=>{e.preventDefault(); isBoosting=false;});

        applyUI();
    </script>
</body>
</html>
